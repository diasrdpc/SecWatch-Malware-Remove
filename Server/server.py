import redis
import threading

redis_client = redis.StrictRedis(host='redis', port=6379, db=0)

delimeter = ":#:"
server_up_channel = 'svr-up'
server_down_channel = 'svr-down'


def messageHandler(message):
    if(message == "PING"):
        server_producer("PONG")

def server_producer(message):
    redis_client.publish(server_down_channel, message)

def server_consumer():
    pubsub = redis_client.pubsub()
    pubsub.subscribe(server_up_channel)

    for message in pubsub.listen():
        if message['type'] == 'message':
            received_message = message['data'].decode('utf-8')
            print(f"Server (Received): {received_message}", flush=True)
            message_handler_thread = threading.Thread(target=messageHandler, args=(received_message,))
            message_handler_thread.start()
            

if __name__ == '__main__':
    print("Starting server...")
    #producer_thread = threading.Thread(target=server_producer)
    consumer_thread = threading.Thread(target=server_consumer)

    #producer_thread.start()
    consumer_thread.start()

    #producer_thread.join()
    #consumer_thread.join()
